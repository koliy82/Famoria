package family

import (
	"fmt"
	"github.com/mymmrac/telego"
	tu "github.com/mymmrac/telego/telegoutil"
	"go.mongodb.org/mongo-driver/bson"
	"go.uber.org/zap"
	"go_tg_bot/internal/bot/callback"
	"go_tg_bot/internal/database/mongo/repositories/brak"
	"go_tg_bot/internal/database/mongo/repositories/user"
	"go_tg_bot/internal/pkg/html"
	"math/rand/v2"
	"time"
)

type leaveKid struct {
	cm       *callback.CallbacksManager
	brakRepo brak.Repository
	userRepo user.Repository
	log      *zap.Logger
}

func (e leaveKid) Handle(bot *telego.Bot, update telego.Update) {
	from := update.Message.From
	params := &telego.SendMessageParams{
		ChatID:    tu.ID(update.Message.Chat.ID),
		ParseMode: telego.ModeHTML,
		ReplyParameters: &telego.ReplyParameters{
			MessageID:                update.Message.GetMessageID(),
			AllowSendingWithoutReply: true,
		},
	}
	b, _ := e.brakRepo.FindByKidID(from.ID)
	if b == nil {
		_, _ = bot.SendMessage(params.WithText(
			fmt.Sprintf("%s, Ñ‚Ñ‹ ÐµÑ‰Ñ‘ Ð½Ðµ Ñ€Ð¾Ð´Ð¸Ð»ÑÑ. âŒš", html.UserMention(from))),
		)
		return
	}

	yesCallback := e.cm.DynamicCallback(callback.DynamicOpts{
		Label:    "Ð”Ð°.",
		CtxType:  callback.OneClick,
		OwnerIDs: []int64{from.ID},
		Time:     time.Duration(60) * time.Minute,
		Callback: func(query telego.CallbackQuery) {
			err := e.brakRepo.Update(
				bson.M{"_id": b.OID},
				bson.M{"$set": bson.D{
					{"baby_user_id", nil},
					{"baby_create_date", nil},
				}},
			)
			if err != nil {
				e.log.Sugar().Error(err)
				return
			}

			r := rand.IntN(45)
			text := ""
			switch {
			case r >= 0 && r <= 15:
				text = fmt.Sprintf("%s ÑˆÑ‘Ð» Ð¿Ð¾ Ð´Ð¾Ñ€Ð¾Ð³Ðµ Ðº Ð´ÐµÑ‚ÑÐºÐ¾Ð¼Ñƒ Ð´Ð¾Ð¼Ñƒ, ÐºÐ¾Ð³Ð´Ð° Ð²Ð´Ñ€ÑƒÐ³ Ð½Ð° Ð½ÐµÐ³Ð¾ Ð½Ð°Ð¿Ð°Ð»Ð¾ ÑÑ‚Ð°Ð´Ð¾ Ð±ÐµÐ»Ñ‹Ñ… Ð¸ Ð¿ÑƒÑˆÐ¸ÑÑ‚Ñ‹Ñ… ÐºÐ¾Ñ‚Ð¸ÐºÐ¾Ð²! ÐžÐ½Ð¸ Ð½Ð¾ÑÐ¸Ð»Ð¸ ÐµÐ³Ð¾ Ð½Ð° Ð»Ð°Ð¿ÐºÐ°Ñ…, Ð¿Ð¾Ð´Ð±Ñ€Ð°ÑÑ‹Ð²Ð°Ð»Ð¸ Ð² Ð²Ð¾Ð·Ð´ÑƒÑ… Ð¸ Ð¸Ð³Ñ€Ð°Ð»Ð¸ Ñ Ð½Ð¸Ð¼ Ð² Ð¿Ñ€ÑÑ‚ÐºÐ¸. Ð’ÐµÑÐµÐ»Ð°Ñ ÐºÐ¾Ñ‚ÑÑ‡ÑŒÑ Ð°Ñ€Ð¼Ð¸Ñ Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð¸Ð»Ð° ÐµÐ³Ð¾ Ð¿Ñ€ÑÐ¼Ð¾ Ð´Ð¾ Ð´Ð²ÐµÑ€ÐµÐ¹ Ð´ÐµÑ‚ÑÐºÐ¾Ð³Ð¾ Ð´Ð¾Ð¼Ð°, Ð³Ð´Ðµ ÐµÐ³Ð¾ Ð¶Ð´Ð°Ð»Ð¸ Ñ Ñ€Ð°Ð´Ð¾ÑÑ‚ÑŒÑŽ Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¼Ð¸ Ð¾Ð±ÑŠÑÑ‚Ð¸ÑÐ¼Ð¸.", html.UserMention(from))
			case r >= 16 && r <= 20:
				text = fmt.Sprintf("%s Ñ€ÐµÑˆÐ¸Ð» Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð¾Ñ‚ ÑÐ²Ð¾Ð¸Ñ… Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÐµÐ¹ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒÑÑ Ð² Ð´ÐµÑ‚ÑÐºÐ¸Ð¹ Ð´Ð¾Ð¼, Ð¼ÐµÑ‡Ñ‚Ð°Ñ Ð¾ Ð»ÑƒÑ‡ÑˆÐµÐ¹ Ð¶Ð¸Ð·Ð½Ð¸ Ð¸ Ð±Ð¾Ð»ÑŒÑˆÐµÐ¹ Ð·Ð°Ð±Ð¾Ñ‚Ðµ. ÐžÐ½ ÑÐ¾Ð±Ñ€Ð°Ð» ÑÐ²Ð¾Ð¸ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾Ñ‡Ð¸ÑÐ»ÐµÐ½Ð½Ñ‹Ðµ Ð²ÐµÑ‰Ð¸ Ð¸ Ñ‚Ð¸Ñ…Ð¾Ð½ÑŒÐºÐ¾ Ð²Ñ‹ÑˆÐµÐ» Ð¸Ð· Ð´Ð¾Ð¼Ð° Ð² Ñ‚ÐµÐ¼Ð½Ð¾Ñ‚Ðµ. ÐŸÐ¾ Ð¿ÑƒÑ‚Ð¸ Ð¾Ð½ ÑÑ‚Ð¾Ð»ÐºÐ½ÑƒÐ»ÑÑ Ñ Ð½ÐµÐ¿Ñ€ÐµÐ´Ð²Ð¸Ð´ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¿Ñ€ÐµÐ³Ñ€Ð°Ð´Ð°Ð¼Ð¸, Ð½Ð¾ ÐµÐ³Ð¾ Ñ€ÐµÑˆÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð½Ðµ Ð¾ÑÐ»Ð°Ð±ÐµÐ²Ð°Ð»Ð°. ÐžÐ´Ð½Ð°ÐºÐ¾, Ð² Ð´Ð¾Ð»Ð¸Ð½Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð¾Ð½ Ð¿Ñ‹Ñ‚Ð°Ð»ÑÑ Ð¿ÐµÑ€ÐµÑÐµÑ‡ÑŒ, ÑÐ»ÑƒÑ‡Ð¸Ð»ÑÑ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð»Ð¸Ð²ÐµÐ½ÑŒ. Ð ÐµÐ±Ñ‘Ð½Ð¾Ðº Ð¾ÐºÐ°Ð·Ð°Ð»ÑÑ Ð² Ð±ÐµÐ´Ðµ Ð¸ Ð±ÐµÐ· Ð½Ð°Ð´ÐµÐ¶Ð´Ñ‹ Ð½Ð° Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ. ÐžÐ½ Ð»ÐµÐ¶Ð°Ð» Ð½Ð° Ð·ÐµÐ¼Ð»Ðµ, Ð¼Ð¾ÐºÑ€Ñ‹Ð¹ Ð¸ Ð¸ÑÐ¿ÑƒÐ³Ð°Ð½Ð½Ñ‹Ð¹, Ð¿Ð¾ÐºÐ° ÐµÐ³Ð¾ ÑÐ¸Ð»Ñ‹ Ð¿Ð¾ÑÑ‚ÐµÐ¿ÐµÐ½Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐ»Ð¸ ÐµÐ³Ð¾ Ñ‚ÐµÐ»Ð¾. ÐÐ¸ÐºÑ‚Ð¾ Ð½Ðµ Ð·Ð½Ð°Ð» Ð¾ ÐµÐ³Ð¾ Ð¿ÐµÑ‡Ð°Ð»Ð¸ Ð¸ Ð¿Ð¾Ñ‚ÐµÑ€Ðµ, Ð¸ ÐµÐ³Ð¾ Ð¼ÐµÑ‡Ñ‚Ñ‹ Ð¾ Ð»ÑƒÑ‡ÑˆÐµÐ¹ Ð¶Ð¸Ð·Ð½Ð¸ Ð¸ÑÑ‡ÐµÐ·Ð»Ð¸ Ð²Ð¼ÐµÑÑ‚Ðµ Ñ ÐµÐ³Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¼ Ð´Ñ‹Ñ…Ð°Ð½Ð¸ÐµÐ¼.", html.UserMention(from))
			case r >= 21 && r <= 30:
				text = fmt.Sprintf("%s ÑƒÑÑ‚Ð°Ð² Ð¾Ñ‚ Ð±ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ñ… Ð¿Ñ€Ð°Ð²Ð¸Ð» Ð¸ Ð·Ð°Ð¿Ñ€ÐµÑ‚Ð¾Ð², ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½Ð°ÐºÐ»Ð°Ð´Ñ‹Ð²Ð°Ð»Ð¸ Ð½Ð° Ð½ÐµÐ³Ð¾ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ð¸, Ñ€ÐµÑˆÐ¸Ð» Ð¿Ð¾ÐºÐ¸Ð½ÑƒÑ‚ÑŒ ÑÐ²Ð¾Ð¹ Ð´Ð¾Ð¼ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒÑÑ Ð² Ð´ÐµÑ‚ÑÐºÐ¸Ð¹ Ð´Ð¾Ð¼. ÐšÐ¾Ð³Ð´Ð° Ð¾Ð½ Ð¿Ñ€Ð¸ÑˆÑ‘Ð» Ñ‚ÑƒÐ´Ð°, ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸ Ð±Ñ‹Ð»Ð¸ Ð¿Ð¾Ñ€Ð°Ð¶ÐµÐ½Ñ‹ ÐµÐ³Ð¾ Ñ€ÐµÑˆÐ¸Ð¼Ð¾ÑÑ‚ÑŒÑŽ Ð¸ ÑÐºÐ°Ð·Ð°Ð»Ð¸: \"ÐœÑ‹ Ñ€Ð°Ð´Ñ‹ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ Ñ‚ÐµÐ±Ñ Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¼Ð¸ Ð¾Ð±ÑŠÑÑ‚Ð¸ÑÐ¼Ð¸, Ð¼Ð°Ð»Ñ‹Ñˆ! Ð—Ð´ÐµÑÑŒ Ñ‚Ñ‹ Ð½Ð°Ð¹Ð´Ñ‘ÑˆÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ð´Ð¾Ð¼ Ð¸ Ð½Ð¾Ð²ÑƒÑŽ ÑÐµÐ¼ÑŒÑŽ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð±Ð¾Ñ‚Ð¸Ñ‚ÑŒÑÑ Ð¾ Ñ‚ÐµÐ±Ðµ.\" Ð ÐµÐ±Ñ‘Ð½Ð¾Ðº ÑƒÐ»Ñ‹Ð±Ð½ÑƒÐ»ÑÑ Ð¸ Ð¿Ð¾Ð½ÑÐ», Ñ‡Ñ‚Ð¾ Ð¾Ð½ ÑÐ´ÐµÐ»Ð°Ð» Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€, Ð¸ Ð²Ð¼ÐµÑÑ‚Ðµ Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð´Ñ€ÑƒÐ·ÑŒÑÐ¼Ð¸ Ð½Ð°Ñ‡Ð°Ð» ÑÐ²Ð¾Ñ‘ Ð½Ð¾Ð²Ð¾Ðµ Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð² Ð´ÐµÑ‚ÑÐºÐ¾Ð¼ Ð´Ð¾Ð¼Ðµ.", html.UserMention(from))
			case r >= 31 && r <= 40:
				text = fmt.Sprintf("%s ÑˆÑ‘Ð» Ð½Ð° ÐºÐ¾Ð½Ñ†ÐµÑ€Ñ‚ ÐœÐ¾Ñ€Ð³ÐµÐ½ÑˆÑ‚ÐµÑ€Ð½Ð°, Ð¾Ð½ Ð±Ñ‹Ð» Ð½Ð°ÑÑ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð·Ð±ÑƒÐ´Ð¾Ñ€Ð°Ð¶ÐµÐ½ Ð¸ Ð²Ð¾ÑÑ‚Ð¾Ñ€Ð¶ÐµÐ½, Ñ‡Ñ‚Ð¾ ÐµÐ³Ð¾ ÑÐ½ÐµÑ€Ð³Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¿Ð¾Ð»Ð½ÑÐ»Ð° ÐµÐ³Ð¾ ÑÐ°Ð¼Ð¾Ð³Ð¾. ÐžÐ½ Ð¿Ð¾Ð´Ð¿Ñ€Ñ‹Ð³Ð¸Ð²Ð°Ð» Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ²Ð°Ð» Ð½Ð° ÑÐ²Ð¾ÐµÐ¼ Ð¿ÑƒÑ‚Ð¸, Ð½ÐµÑÑ Ñ ÑÐ¾Ð±Ð¾Ð¹ Ð½ÐµÐ²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾Ðµ Ð²ÐµÑÐµÐ»ÑŒÐµ. ÐÐ¾ Ð²Ð½ÐµÐ·Ð°Ð¿Ð½Ð¾ ÐµÐ³Ð¾ ÑÐ½Ñ‚ÑƒÐ·Ð¸Ð°Ð·Ð¼ Ð¿ÐµÑ€ÐµÑˆÐµÐ» Ð² Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‹ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾Ð³Ð¾, Ð¸ Ð¾Ð½ Ð½Ð°Ñ‡Ð°Ð» ÑÐ²ÐµÑ€ÐºÐ°Ñ‚ÑŒ ÑÑ€ÐºÐ¸Ð¼ ÑÐ²ÐµÑ‚Ð¾Ð¼, Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÑÑÑŒ Ð² Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÑƒÑŽ Ð·Ð²ÐµÐ·Ð´Ñƒ. Ð’ÑÐµ, ÐºÑ‚Ð¾ Ð²Ð¸Ð´ÐµÐ» ÑÑ‚Ð¾ Ñ‡ÑƒÐ´Ð¾, Ð²Ð¾ÑÑ…Ð¸Ñ‰ÐµÐ½Ð½Ð¾ Ð·Ð°Ð¼Ð¸Ñ€Ð°Ð»Ð¸, Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ñ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾Ðµ. Ð˜ Ñ…Ð¾Ñ‚Ñ ÐµÐ³Ð¾ Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð¾ÑÑŒ Ñ€Ð°Ð½ÑŒÑˆÐµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸, Ñ€ÐµÐ±Ñ‘Ð½Ð¾Ðº Ð¾ÑÑ‚Ð°Ð²Ð¸Ð» Ð¿Ð°Ð¼ÑÑ‚ÑŒ Ð¾ ÑÐ²Ð¾ÐµÐ¹ Ð½ÐµÐ¿Ð¾Ð´Ñ€Ð°Ð¶Ð°ÐµÐ¼Ð¾Ð¹ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ Ð¸ Ñ€Ð°Ð´Ð¾ÑÑ‚Ð¸ Ð² ÑÐµÑ€Ð´Ñ†Ð°Ñ… Ð²ÑÐµÑ…, ÐºÑ‚Ð¾ Ð²Ð¸Ð´ÐµÐ» ÐµÐ³Ð¾.", html.UserMention(from))
			case r >= 41 && r <= 45:
				text = fmt.Sprintf("%s, ÑˆÑ‘Ð» Ðº Ð´ÐµÑ‚ÑÐºÐ¾Ð¼Ñƒ Ð´Ð¾Ð¼Ñƒ, Ð½ÐµÑÑ Ñ ÑÐ¾Ð±Ð¾Ð¹ ÑÐ²Ð¾ÑŽ ÐºÑ€ÑƒÑ‚ÑƒÑŽ Ð¼ÐµÑ…Ð°Ð½Ð¸ÐºÑƒ Ð¸Ð· Dota 2. Ð’Ð½ÐµÐ·Ð°Ð¿Ð½Ð¾, Ð¿ÐµÑ€ÐµÐ´ Ð½Ð¸Ð¼ Ð²Ñ‹ÑÐºÐ¾Ñ‡Ð¸Ð» ÑÐ¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ€Ð°Ð¶ÐµÑÐºÐ¸Ð¹ Ð³ÐµÑ€Ð¾Ð¹, Ð¸ Ñ€ÐµÐ±Ñ‘Ð½Ð¾Ðº ÑÑ€Ð°Ð·Ñƒ Ð¶Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð» ÑÐ²Ð¾Ð¸ Ð½Ð°Ð²Ñ‹ÐºÐ¸. ÐžÐ½ Ð¿Ñ€Ñ‹Ð³Ð½ÑƒÐ» Ð² Ð²Ð¾Ð·Ð´ÑƒÑ…, Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÐ»ÑÑ Ð¸ Ð½Ð°Ð½Ñ‘Ñ Ð¼Ð¾Ñ‰Ð½Ñ‹Ð¹ ÑƒÐ´Ð°Ñ€, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ Ð²Ñ€Ð°Ð³Ð° Ð² ÐºÐ¾ÑÐ¼Ð¾Ñ. ÐŸÑ€Ð¾Ñ…Ð¾Ð¶Ð¸Ðµ Ð¾ÑˆÐ°Ñ€Ð°ÑˆÐµÐ½Ð¾ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ÑÑŒ, Ð° Ñ€ÐµÐ±Ñ‘Ð½Ð¾Ðº ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ð» ÑÐ²Ð¾Ð¹ Ð¿ÑƒÑ‚ÑŒ, ÑÐ¾Ð±Ð¸Ñ€Ð°Ñ Ð°Ð¿Ð»Ð¾Ð´Ð¸ÑÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸ Ð²Ð¾ÑÑ…Ð¸Ñ‰Ñ‘Ð½Ð½Ñ‹Ðµ Ð²Ð·Ð³Ð»ÑÐ´Ñ‹.", html.UserMention(from))
			default:
				text = "Ð§Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº..."
			}

			_, _ = bot.SendMessage(params.
				WithText(text).
				WithReplyMarkup(nil),
			)
		},
	})

	_, _ = bot.SendMessage(params.
		WithText(fmt.Sprintf("%s, Ñ‚Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð¿Ð¾ÐºÐ¸Ð½ÑƒÑ‚ÑŒ ÑÐ²Ð¾ÑŽ ÑÐµÐ¼ÑŒÑŽ? ðŸ ", html.UserMention(from))).
		WithReplyMarkup(tu.InlineKeyboard(tu.InlineKeyboardRow(yesCallback.Inline()))),
	)
}
